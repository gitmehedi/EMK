<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Inherited menuitem-->
        <menuitem name="Purchases"
                  id="purchase.menu_purchase_root"
                  groups="purchase.group_purchase_manager,purchase.group_purchase_user,stock.group_stock_user"
                  web_icon="purchase,static/description/icon.png"
                  sequence="25"/>
        <!-- Inherited tree view-->
        <record id="indent_pr_view_tree" model="ir.ui.view">
            <field name="name">purchase.requisition.view.tree</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_tree"/>
            <field name="arch" type="xml">
                <data>
                    <xpath expr="//field[@name='name']" position="attributes">
                        <attribute name="string">Purchase Requisition</attribute>
                    </xpath>
                    <xpath expr="//field[@name='date_end']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='ordering_date']" position="replace">
                        <field name="requisition_date"/>
                    </xpath>
                    <xpath expr="//field[@name='origin']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                </data>
            </field>
        </record>
        <!-- Inherited Form view-->
        <record id="indent_pr_view_form" model="ir.ui.view">
            <field name="name">purchase.requisition.view.form</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_form"/>
            <field name="arch" type="xml">
                <data>
                    <header>
                        <button name="action_approve" groups="gbs_purchase_requisition.group_purchase_requisition_approver"
                                states="approve_head_procurement" string="Approve" type="object" class="btn-primary"/>
                        <button name="action_cancel" groups="gbs_purchase_requisition.group_purchase_requisition_validator,gbs_purchase_requisition.group_purchase_requisition_approver"
                                states="review_plant_incharge,approve_head_procurement" string="Cancel" type="object"/>
                    </header>
                    <xpath expr="//button[@name='action_open']" position="replace">
                        <button name="action_open" groups="gbs_purchase_requisition.group_purchase_requisition_validator"
                                states="in_progress" string="Validate" type="object" class="btn-primary"/>
                    </xpath>
                    <xpath expr="//field[@name='state']" position="replace">
                        <field name="state" widget="statusbar" statusbar_visible="draft,in_progress,approve_head_procurement,done"/>
                    </xpath>
                    <xpath expr="//label[@for='name']" position="replace">
                        <label for="name" class="oe_edit_only oe_inline" string="Purchase Requisition"/>
                    </xpath>
                    <xpath expr="//field[@name='name']" position="attributes">
                        <attribute name="readonly">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='type_id']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='schedule_date']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='origin']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='date_end']" position="replace">
                        <field name="requisition_date" attrs="{'readonly': [('state','in',('done'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='ordering_date']" position="replace">
                        <field name="required_date" attrs="{'readonly': [('state','in',('done'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='user_id']" position="after" type="object">
                        <field name="department_id" attrs="{'readonly': [('state','in',('done'))]}"
                               options='{"no_open": True,"no_create": 1, "no_create_edit":1}'/>
                        <field name="operating_unit_id" groups="operating_unit.group_multi_operating_unit"
                               options='{"no_open": True,"no_create": 1, "no_create_edit":1}' attrs="{'readonly': [('state','in',('done'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='vendor_id']" position="attributes">
                        <attribute name="attrs">{'readonly': [('state','in',('done'))]}</attribute>
                    </xpath>
                    <xpath expr="//field[@name='vendor_id']" position="after">
                        <field name="indent_ids" widget="many2many_tags" domain="[('operating_unit_id','=',operating_unit_id)]"
                               attrs="{'readonly': [('state','in',('done'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='company_id']" position="replace">
                        <field name="company_id" groups="base.group_multi_company" attrs="{'readonly': [('state','in',('done'))]}"
                               options='{"no_open": True,"no_create": 1, "no_create_edit":1}'/>
                    </xpath>
                    <xpath expr="//field[@name='company_id']" position="after">
                        <field name="region_type" widget="selection" readonly="1"
                               attrs="{'invisible': [('state','in',('draft','in_progress','review_plant_incharge'))]}"/>
                        <field name="purchase_by" widget="selection" readonly="1"
                               attrs="{'invisible': [('state','in',('draft','in_progress','review_plant_incharge'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='product_id']" position="after" type="object">
                        <field name="name"/>
                    </xpath>
                    <xpath expr="//field[@name='product_qty']" position="attributes" type="object">
                        <attribute name="string">In Stock</attribute>
                    </xpath>
                    <xpath expr="//field[@name='qty_ordered']" position="replace" type="object">
                    <field name="product_ordered_qty"/>
                    </xpath>
                    <xpath expr="//field[@name='price_unit']" position="after" type="object">
                        <field name="last_purchse_date"/>
                        <field name="last_qty"/>
                        <field name="last_product_uom_id"/>
                        <field name="last_price_unit"/>
                        <field name="remark"/>
                    </xpath>

                    <xpath expr="//page[1]" position="after">
                        <page string="Attachments">
                            <field name="attachment_ids" widget="one2many" >
                                <tree string="Attachments" editable="top">
                                    <field name="name" string="Title"/>
                                    <field name="datas_fname" invisible="1"/>
                                    <field name="db_datas" filename="datas_fname"/>
                                    <!--<field name="res_name"/>-->
                                    <!--<field name="res_model"/>-->
                                    <!--<field name="res_field"/>-->
                                    <!--<field name="res_id"/>-->
                                    <!--<field name="create_uid"/>-->
                                    <!--<field name="create_date"/>-->
                                    <!--<field name="company_id"/>-->
                                </tree>
                            </field>
                        </page>
                    </xpath>

                </data>
            </field>
        </record>
        <!--Inherited view for field access-->
        <!--<record id="inherit_indent_pr_view_form" model="ir.ui.view">-->
        <!--<field name="name">indent.pr.view.form.inherit</field>-->
        <!--<field name="model">purchase.requisition</field>-->
        <!--<field name="inherit_id" ref="indent_pr_view_form" />-->
        <!--<field name="groups_id" eval="[(6, 0, [ref('gbs_purchase_requisition.group_purchase_requisition_approver') ])]" />-->
        <!--<field name="arch" type="xml">-->
        <!--<field name="buying_type" position="attributes">-->
        <!--<attribute name="readonly">0</attribute>-->
        <!--</field>-->
        <!--<field name="purchase_by" position="attributes">-->
        <!--<attribute name="readonly">0</attribute>-->
        <!--</field>-->
        <!--</field>-->
        <!--</record>-->

        <record model="ir.actions.act_window" id="purchase_requisition.action_purchase_requisition">
            <field name="name">Purchase Requisition</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.requisition</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"search_default_user_id":uid}</field>
            <field name="search_view_id" ref="purchase_requisition.view_purchase_requisition_filter"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to start a new purchase requisition.
                </p><p>
                Example of purchase agreements include call for tenders and blanket orders.
            </p><p>
                In a call for tenders, you can record the products you need to buy
                and generate the creation of RfQs to vendors. Once the tenders have
                been registered, you can review and compare them and you can
                validate some and cancel others.
            </p><p>
                For a blanket order, you can record an agreement for a specifc period
                (e.g. a year) and you order products within this agreement, benefiting
                from the negociated prices.
            </p>
            </field>
        </record>

        <menuitem
                id="purchase_requisition.menu_purchase_requisition_pro_mgt"
                sequence="10"
                name="Purchase Requisition"
                parent="purchase.menu_procurement_management"
                action="purchase_requisition.action_purchase_requisition"
                groups="gbs_purchase_requisition.group_purchase_requisition_validator,gbs_purchase_requisition.group_purchase_requisition_approver,stock.group_stock_user"/>
    </data>
</odoo>