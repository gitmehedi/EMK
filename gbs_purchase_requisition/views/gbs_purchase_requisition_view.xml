<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Inherited menuitem-->
        <menuitem name="Purchases"
                  id="purchase.menu_purchase_root"
                  groups="purchase.group_purchase_manager,purchase.group_purchase_user,stock.group_stock_user,gbs_purchase_requisition.group_purchase_requisition_validator,gbs_purchase_requisition.group_purchase_requisition_approver"
                  web_icon="purchase,static/description/icon.png"
                  sequence="25"/>

        <!-- Inherited tree view-->
        <record id="inherit_pr_view_tree" model="ir.ui.view">
            <field name="name">purchase.requisition.view.tree</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_tree"/>
            <field name="arch" type="xml">
                <data>
                    <xpath expr="//field[@name='name']" position="attributes">
                        <attribute name="string">Purchase Requisition</attribute>
                    </xpath>
                    <xpath expr="//field[@name='date_end']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='ordering_date']" position="replace">
                        <field name="requisition_date"/>
                    </xpath>
                    <xpath expr="//field[@name='origin']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                </data>
            </field>
        </record>
        <!-- Inherited Form view-->
        <record id="inherit_pr_view_form" model="ir.ui.view">
            <field name="name">purchase.requisition.view.form</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_form"/>
            <field name="arch" type="xml">
                <data>
                    <header>
                        <button name="%(purchase_requisition.action_purchase_requisition_to_so)d" type="action"
                                string="New Quotation" class="btn-primary"
                                attrs="{'invisible': [('state', 'not in', ['approve_head_procurement','done'])]}"/>
                        <button name="action_approve" groups="gbs_purchase_requisition.group_purchase_requisition_approver"
                                states="approve_head_procurement" string="Approve" type="object" class="btn-primary"/>

                    </header>
                    <xpath expr="//form" position="attributes">
                        <attribute name="duplicate">0</attribute>
                    </xpath>
                    <xpath expr="//field[@name='line_ids']" position="attributes">
                        <attribute name="attrs">{'readonly': [('state','in',('done','cancel','close'))]}</attribute>
                    </xpath>
                    <xpath expr="//button[@name='action_cancel']" position="replace">
                        <button name="action_cancel" groups="commercial.group_commercial_user,gbs_purchase_requisition.group_purchase_requisition_validator,gbs_purchase_requisition.group_purchase_requisition_approver"
                                confirm="Are you sure you want to cancel?" states="approve_head_procurement,done" string="Cancel" type="object"/>
                    </xpath>
                    <xpath expr="//button[@name='action_draft']" position="replace">
                        <button name="action_draft" states="cancel" string="Reset to Draft" type="object" invisible="1"/>
                    </xpath>
                    <xpath expr="//button[@name='action_in_progress']" position="before">
                        <button name="action_done" states="done" confirm="Are you sure you want to continue?" string="Done" type="object" groups="gbs_procure_n_commercial_access.group_pr_done"/>
                        <button name="action_back_to_approve" states="cancel,close" string="Reset to Approve" type="object" groups="commercial.group_commercial_manager"/>
                    </xpath>
                    <xpath expr="//button[@name='action_open']" position="replace">
                        <button name="action_open" groups="gbs_purchase_requisition.group_purchase_requisition_validator"
                                states="in_progress" string="Validate" type="object" class="btn-primary"/>
                    </xpath>
                    <xpath expr="//field[@name='order_count']" position="attributes">
                        <attribute name="string">Quotations</attribute>
                    </xpath>
                    <xpath expr="//sheet/div[@name='button_box']" position="inside">
                        <field name="indent_ids" invisible="True"/>
                        <button name="action_get_indent" type="object"
                            class="oe_stat_button" icon="fa-list-alt"
                            attrs="{'invisible':[('indent_ids','=',[])]}">
                            <label string="Indents"/>
                        </button>
                    </xpath>
                    <xpath expr="//field[@name='state']" position="replace">
                        <field name="state" widget="statusbar" statusbar_visible="draft,in_progress,approve_head_procurement,done"/>
                    </xpath>
                    <xpath expr="//label[@for='name']" position="replace">
                        <label for="name" class="oe_edit_only oe_inline" string="Purchase Requisition"/>
                    </xpath>
                    <xpath expr="//field[@name='name']" position="attributes">
                        <attribute name="readonly">1</attribute>
                    </xpath>

                    <!-- suplier invisible -->
                    <xpath expr="//field[@name='vendor_id']" position="attributes">
                        <!--<attribute name="string">Supplier</attribute>-->
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <!-- suplier invisible -->

<!--                    <xpath expr="//field[@name='type_id']" position="attributes">-->

<!--                        <attribute name="invisible">1</attribute>-->
<!--                    </xpath>-->
                    <xpath expr="//field[@name='schedule_date']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='origin']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='date_end']" position="replace">
                        <field name="requisition_date" attrs="{'readonly': [('state','!=','draft')]}"/>
                    </xpath>
                    <xpath expr="//field[@name='ordering_date']" position="replace">
                        <field name="required_date" attrs="{'readonly': [('state','!=','draft')]}"/>
                    </xpath>
                    <xpath expr="//field[@name='required_date']" position="after">
                        <field name="purchase_from" placeholder="Please Select" attrs="{'readonly': [('state','!=','draft')]}"/>
                    </xpath>
                    <xpath expr="//field[@name='picking_type_id']" position="attributes">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <!--<field name="operating_unit_id" groups="operating_unit.group_multi_operating_unit"-->
                    <!--options='{"no_open": True,"no_create": 1, "no_create_edit":1}' attrs="{'readonly': [('state','!=','draft')]}"/>-->
                    <!--<xpath expr="//field[@name='vendor_id']" position="attributes">-->
                    <!--<attribute name="attrs">{'readonly': [('state','in',('done'))]}</attribute>-->
                    <!--</xpath>-->
                    <xpath expr="//field[@name='vendor_id']" position="after">
                        <field name="dept_location_id" options="{'no_create': True,'no_open':True}"/>
                        <field name="indent_ids" widget="many2many_tags" domain="[('operating_unit_id','=',operating_unit_id),('state','=','inprogress'),('pr_indent_check','=',True)]"
                               attrs="{'readonly': [('state','!=','draft')]}" options='{"no_open": True,"no_create": 1, "no_create_edit":1}'/>
                    </xpath>
                    <xpath expr="//field[@name='company_id']" position="replace">
                        <field name="company_id" groups="base.group_multi_company" attrs="{'readonly': [('state','!=','draft')]}"
                               invisible="1" options='{"no_open": True,"no_create": 1, "no_create_edit":1}'/>
                    </xpath>
                    <xpath expr="//field[@name='company_id']" position="after">
                        <field name="region_type" widget="selection" readonly="1"
                               attrs="{'invisible': [('state','in',('draft','in_progress'))]}"/>
                        <field name="purchase_by" widget="selection" readonly="1"
                               attrs="{'invisible': [('state','in',('draft','in_progress'))]}"/>
                    </xpath>
                    <xpath expr="//field[@name='product_id']" position="after" type="object">
                        <field name="name"/>
                    </xpath>
                    <xpath expr="//field[@name='product_qty']" position="attributes" type="object">
                        <attribute name="string">In Stock</attribute>
                        <attribute name="readonly">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='qty_ordered']" position="replace" type="object">
                        <field name="product_ordered_qty"/>
                    </xpath>
                    <xpath expr="//field[@name='product_ordered_qty']" position="after" type="object">
                        <field name="due_qty"/>
                    </xpath>
                    <xpath expr="//field[@name='product_ordered_qty']" position="before" type="object">
                        <field name="store_code"/>
                    </xpath>
                    <xpath expr="//field[@name='price_unit']" position="attributes" type="object">
                        <attribute name="readonly">1</attribute>
                    </xpath>
                    <xpath expr="//notebook/page/field/tree/field[@name='schedule_date']" position="attributes" type="object">
                        <attribute name="invisible">1</attribute>
                    </xpath>
                    <xpath expr="//field[@name='price_unit']" position="after" type="object">
                        <field name="last_purchase_date" readonly="1"/>
                        <field name="last_qty" readonly="1"/>
                        <field name="last_product_uom_id" readonly="1"/>
                        <field name="last_price_unit" readonly="1"/>
                        <field name="remark"/>
                    </xpath>

                    <xpath expr="//notebook/page[1]" position="after">
                        <page string="Attachments">
                            <field name="attachment_ids" widget="one2many_list" context="{'default_res_id': id, 'default_res_model': 'purchase.requisition'}">
                                <tree string="Attachments" editable="top">
                                    <field name="res_id" invisible="1"/>
                                    <field name="res_model" invisible="1"/>
                                    <field name="name" string="Title"/>
                                    <field name="datas_fname" invisible="1"/>
                                    <field name="db_datas" filename="datas_fname" string="File"/>
                                </tree>
                            </field>
                        </page>
                        <!-- add supplier, company, operating unit -->
                        <page string="Others">
                            <group>
                                <group>
                                    <field name="vendor_id" string='Supplier' attrs="{'readonly': [('state','in',('done'))]}" context="{'search_default_supplier':1, 'default_supplier':1, 'default_customer':0}" domain="[('supplier','=',True),('parent_id', '=', False)]"/>
                                    <field name="company_id" groups="base.group_multi_company" attrs="{'readonly': [('state','!=','draft')]}" options='{"no_open": True,"no_create": 1, "no_create_edit":1}'/>
                                    <field name="operating_unit_id" groups="operating_unit.group_multi_operating_unit"
                                           options='{"no_open": True,"no_create": 1, "no_create_edit":1}' attrs="{'readonly': [('state','!=','draft')]}"/>
                                </group>
                            </group>
                        </page>
                    </xpath>

                </data>
            </field>
        </record>

        <record id="inherit_pr_filter_view_form" model="ir.ui.view">
            <field name="name">purchase.requisition.filter.view.form</field>
            <field name="model">purchase.requisition</field>
            <field name="inherit_id" ref="purchase_requisition.view_purchase_requisition_filter"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='name']" position="replace">
                    <field name="name" string="Purchase Requisition" filter_domain="['|', ('name','ilike',self), ('origin','ilike',self)]"/>
                </xpath>
<!--                <xpath expr="//field[@name='type_id']" position="attributes">-->
<!--                    <attribute name="invisible">1</attribute>-->
<!--                </xpath>-->
                <xpath expr="//field[@name='user_id']" position="replace">
                    <field name="indent_ids" />
                    <filter name="my_approval_draft" string="To Confirm" domain="[('state','=','draft')]"/>
                    <filter name="validation" string="To Validate" domain="[('state','=','in_progress')]"/>
                    <filter name="approval" string="To Approve" domain="[('state','=','approve_head_procurement')]"/>
                    <filter name="approval_local_foreign" string="To Approve" domain="[('state','=','done')]"/>
                    <filter name="active" string="Active" domain="[('state', 'in', ('draft','in_progress','approve_head_procurement','done'))]"/>
                </xpath>
            </field>
        </record>

        <record model="ir.actions.act_window" id="purchase_requisition.action_purchase_requisition">
            <field name="name">Purchase Requisition</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.requisition</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="context">{"search_default_user_id":uid}</field>
            <field name="search_view_id" ref="purchase_requisition.view_purchase_requisition_filter"/>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to start a new purchase requisition.
                </p><p>
                Example of purchase agreements include call for tenders and blanket orders.
            </p><p>
                In a call for tenders, you can record the products you need to buy
                and generate the creation of RfQs to vendors. Once the tenders have
                been registered, you can review and compare them and you can
                validate some and cancel others.
            </p><p>
                For a blanket order, you can record an agreement for a specifc period
                (e.g. a year) and you order products within this agreement, benefiting
                from the negociated prices.
            </p>
            </field>
        </record>

        <record model="ir.actions.act_window" id="purchase_requisition.action_purchase_requisition">
            <field name="name">Purchase Requisition</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.requisition</field>
            <field name="context">{'search_default_active':1}</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="gbs_purchase_requisition.inherit_pr_filter_view_form"/>
        </record>

        <record model="ir.actions.act_window" id="action_purchase_requisition_to_validate">
            <field name="name">Purchase Requisition</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.requisition</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="gbs_purchase_requisition.inherit_pr_filter_view_form"/>
            <field name="context">{
                'search_default_validation':1,
                }
            </field>
        </record>

        <record model="ir.actions.act_window" id="action_purchase_requisition_to_approve">
            <field name="name">Purchase Requisition</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">purchase.requisition</field>
            <field name="view_type">form</field>
            <field name="view_mode">tree,form</field>
            <field name="search_view_id" ref="gbs_purchase_requisition.inherit_pr_filter_view_form"/>
            <field name="context">{
                'search_default_approval':1,
                }
            </field>
        </record>

        <menuitem
                id="purchase_requisition.menu_purchase_requisition_pro_mgt"
                sequence="1"
                name="Purchase Requisition"
                parent="purchase.menu_procurement_management"
                action="purchase_requisition.action_purchase_requisition"
                groups="stock.group_stock_user,gbs_purchase_requisition.group_purchase_requisition_validator"/>

        <menuitem
                id="menu_purchase_requisition_pending_approval"
                sequence="2"
                name="Pending PR (Approval)"
                parent="purchase.menu_procurement_management"
                action="action_purchase_requisition_to_approve"
                groups="gbs_purchase_requisition.group_purchase_requisition_approver"/>

        <menuitem
                id="menu_purchase_requisition_pending_validate"
                sequence="3"
                name="Pending PR (Validation)"
                parent="purchase.menu_procurement_management"
                action="action_purchase_requisition_to_validate"
                groups="gbs_purchase_requisition.group_purchase_requisition_validator"/>

        <!--Purchase Product Action-->
        <record id="purchase.product_normal_action_puchased" model="ir.actions.act_window">
            <field name="name">Products</field>
            <field name="type">ir.actions.act_window</field>
            <field name="res_model">product.template</field>
            <field name="view_type">form</field>
            <field name="view_mode">kanban,tree,form</field>
            <field name="context">{"search_default_filter_to_purchase":1,"default_sale_ok": False}</field>
            <field name="search_view_id" eval="False"/> <!-- Force empty -->
            <field name="view_id" eval="False"/> <!-- Force empty -->
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to define a new product.
                </p><p>
                You must define a product for everything you purchase, whether
                it's a physical product, a consumable or services you buy to
                subcontractors.
            </p><p>
                The product form contains detailed information to improve the
                purchase process: prices, procurement logistics, accounting data,
                available vendors, etc.
            </p>
            </field>
        </record>

        <record id="purchase.product_product_action" model="ir.actions.act_window">
            <field name="name">Product Variants</field>
            <field name="res_model">product.product</field>
            <field name="view_mode">tree,kanban,form</field>
            <field name="view_type">form</field>
            <field name="context">{"search_default_filter_to_purchase": 1,"default_sale_ok": False}</field>
            <field name="help" type="html">
                <p class="oe_view_nocontent_create">
                    Click to define a new product.
                </p><p>
                You must define a product for everything you purchase, whether
                it's a physical product, a consumable or services you buy to
                subcontractors.
            </p><p>
                The product form contains detailed information to improve the
                purchase process: prices, procurement logistics, accounting data,
                available vendors, etc.
            </p>
            </field>
        </record>

        <!--Supplier menu-->
        <menuitem
                id="menu_procurement_management_supplier_root"
                name="Vendors"
                parent="purchase.menu_purchase_root"
                sequence="2"/>

        <menuitem
                id="purchase.menu_procurement_management_supplier_name"
                name="Vendors"
                parent="menu_procurement_management_supplier_root"
                action="base.action_partner_supplier_form" sequence="1"/>

        <menuitem
                action="product.product_supplierinfo_type_action"
                id="purchase.menu_product_pricelist_action2_purchase"
                parent="menu_procurement_management_supplier_root" sequence="16"
                groups="purchase.group_manage_vendor_price"/>

        <!--Product menu-->
        <menuitem
                id="menu_procurement_management_product_root"
                name="Products"
                parent="purchase.menu_purchase_root"
                sequence="3"/>

        <menuitem
                name="Products"
                id="purchase.menu_procurement_partner_contact_form"
                action="purchase.product_normal_action_puchased"
                parent="menu_procurement_management_product_root" sequence="1"/>

        <menuitem
                name="Product Variants"
                id="purchase.product_product_menu"
                action="purchase.product_product_action"
                parent="menu_procurement_management_product_root" sequence="2"
                groups="product.group_product_variant"/>

        <!-- Purchase Control Menu -->
        <menuitem
                id="purchase.menu_purchase_control" groups="purchase.group_purchase_manager"
                name="Control" parent="purchase.menu_purchase_root" sequence="4"/>

        <!--Inventory control-->
        <menuitem action="stock.action_receipt_picking_move"
                  id="purchase.menu_action_picking_tree_in_move"
                  groups="purchase.group_purchase_manager"
                  parent="purchase.menu_purchase_control" sequence="11"/>

        <!--Invoice control-->
        <menuitem
                id="purchase.menu_procurement_management_pending_invoice"
                action="purchase.action_invoice_pending"
                parent="purchase.menu_purchase_control"
                groups="purchase.group_purchase_manager"
                sequence="13"/>

        <menuitem
                id="purchase_requisition.menu_purchase_requisition_type"
                sequence="100"
                parent="purchase.menu_purchase_config"
                action="purchase_requisition.tender_type_action"
                groups="base.group_system"/>


        <act_window
            domain="[('requisition_id', '=', active_id)]"
            context="{'default_requisition_id': active_id}"
            id="purchase_requisition.act_res_partner_2_purchase_order"
            name="Purchase orders"
            res_model="purchase.order"
            src_model="purchase.requisition"
            groups="base.group_system"/>

    </data>
</odoo>