<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <!-- Tree View -->
        <record id="mrp_unbuild_tree_view" model="ir.ui.view">
            <field name="name">mrp.unbuild.tree.inherit.mrp.extend</field>
            <field name="model">mrp.unbuild</field>
            <field name="inherit_id" ref="mrp.mrp_unbuild_tree_view"/>
            <field name="arch" type="xml">
                <xpath expr="//tree" position="attributes">
                    <attribute name="decoration-success">state == 'done'</attribute>
                    <attribute name="decoration-danger">state not in ('cancel','done')</attribute>
                    <attribute name="decoration-muted">state == 'cancel'</attribute>
                    <attribute name="default_order">date_unbuild desc</attribute>
                </xpath>
                <xpath expr="//field[@name='location_id']" position="attributes">
                    <attribute name="invisible">1</attribute>
                </xpath>
                <xpath expr="//field[@name='name']" position="after">
                    <field name="date_unbuild"/>
                </xpath>
            </field>
        </record>

        <!-- Form View -->
        <record id="mrp_unbuild_form_view" model="ir.ui.view">
            <field name="name">mrp.unbuild.form.inherit.mrp.extend</field>
            <field name="model">mrp.unbuild</field>
            <field name="inherit_id" ref="mrp.mrp_unbuild_form_view"/>
            <field name="arch" type="xml">
                <xpath expr="//button[@name='%(mrp.action_mrp_unbuild_moves)d']" position="attributes">
                    <attribute name="groups">base.group_system</attribute>
                </xpath>

                <xpath expr="//field[@name='bom_id']" position="after">
                    <field name="has_moves" invisible="1"/>
                </xpath>
                <xpath expr="//field[@name='product_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                    <attribute name="options">{'no_create':True, 'no_create_edit':True,'no_open':True}</attribute>
                </xpath>
                <xpath expr="//field[@name='bom_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                    <attribute name="options">{'no_create':True, 'no_create_edit':True,'no_open':True}</attribute>
                </xpath>
                <xpath expr="//field[@name='product_qty']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                </xpath>
                <xpath expr="//field[@name='product_uom_id']" position="attributes">
                    <attribute name="readonly">1</attribute>
                </xpath>
                <xpath expr="//field[@name='mo_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                    <attribute name="options">{'no_create':True, 'no_create_edit':True,'no_open':True}</attribute>
                </xpath>
                <xpath expr="//field[@name='location_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                </xpath>
                <xpath expr="//field[@name='location_dest_id']" position="attributes">
                    <attribute name="attrs">{'readonly': [('has_moves', '=', True)]}</attribute>
                </xpath>

                <xpath expr="//form/sheet/group/group/field[@name='location_id']" position="replace">
                </xpath>
                <xpath expr="//form/sheet/group/group/field[@name='location_dest_id']" position="replace">
                </xpath>
                <xpath expr="//form/sheet/group/group/field[@name='has_tracking']" position="replace">
                </xpath>
                <xpath expr="//form/sheet/group/group/field[@name='lot_id']" position="replace">
                </xpath>

                <xpath expr="//form/header/button[@name='action_unbuild']" position="after">
                    <button name="action_cancel" string="Cancel" type="object" states="draft"/>
                </xpath>
                <xpath expr="//form/sheet/group/group/field[@name='mo_id']" position="before">
                    <field name="date_unbuild" required="1"
                           attrs="{'readonly': ['|', '|', ('mo_id', '!=', False), ('has_moves', '=', True)]}"/>
                </xpath>

                <xpath expr="//sheet/group" position="after">
                    <notebook>
                        <page string="Produce Products">
                            <field name="produce_line_ids" options="{'reload_on_button': True}" attrs="{'readonly': [('state', '=', 'done')]}">
                                <tree editable="bottom" delete="0" create="0" decoration-muted="is_done">
                                    <field name="product_id" required="1" readonly="1"/>
                                    <field name="product_uom" groups="product.group_uom" readonly="1"/>
                                    <field name="has_tracking" invisible="1"/>
                                    <field name="is_done" invisible="1"/>
                                    <field name="state" invisible="1"/>
                                    <field name="product_uom_qty" attrs="{'readonly': ['|', ('is_done', '=', True), ('has_tracking', 'in', ['lot','serial'])]}" string="To Produce"/>
                                    <field name="quantity_done" string="Produced" readonly="1"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Consume Materials">
                            <field name="consume_line_ids" options="{'reload_on_button': True}" readonly="1">
                                <tree editable="bottom" delete="0" create="0" decoration-muted="is_done">
                                    <field name="product_id" required="1"/>
                                    <field name="product_uom" groups="product.group_uom"/>
                                    <field name="has_tracking" invisible="1"/>
                                    <field name="is_done" invisible="1"/>
                                    <field name="state" invisible="1"/>
                                    <field name="product_uom_qty" string="To Consume"/>
                                    <field name="quantity_done" string="Consumed"/>
                                </tree>
                            </field>
                        </page>
                        <page string="Miscellaneous">
                            <group groups="stock.group_stock_multi_locations" col="4">
                                <field name="picking_type_id" options='{"no_open": 1,"no_create": 1, "no_create_edit":1}'
                                       domain="[('code', '=', 'mrp_operation')]" readonly="1"/>
                                <field name="location_id" options='{"no_open": True,"no_create": 1, "no_create_edit":1}'
                                       domain="[('usage','=','internal')]" readonly="1"/>
                                <field name="has_tracking" invisible="1"/>
                                <field name="location_dest_id" options='{"no_open": True,"no_create": 1, "no_create_edit":1}'
                                       domain="[('usage','=','internal')]" readonly="1"/>
                                <field name="lot_id" attrs="{'invisible': [('has_tracking', '=', 'none')]}" groups="stock.group_production_lot"/>
                            </group>
                        </page>
                    </notebook>
                </xpath>
            </field>
        </record>
    </data>
</odoo>